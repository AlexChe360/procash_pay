require "roda"
require "json"
require "sequel"
require "dotenv/load"
require "net/http"
require "uri"
require_relative "./handlers/whatsapp_handler"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SQLite
DB = Sequel.sqlite("procash.db")

# –¢–∞–±–ª–∏—Ü–∞ payments
DB.create_table? :payments do
  primary_key :id
  String :order_guid
  Integer :chat_id
  String :receipt_url
  DateTime :paid_at
end

class Payment < Sequel::Model(:payments)
end

class App < Roda
  plugin :json
  plugin :render
  plugin :request_headers
  plugin :static, ["/static"], root: File.expand_path(".")

  route do |r|
    r.root do
      response["Content-Type"] = "text/html"
      begin
        File.read("static/index.html")
      rescue => e
        response.status = 500
        "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ index.html: #{e.message}"
      end
    end

    r.get "privacy" do
      view("privacy")
    end

    # Callback –æ—Ç FreedomPay
    r.post "callback" do
      begin
        payload = JSON.parse(r.body.read)

        required = %w[order_guid receipt_url chat_id]
        unless required.all? { |k| payload[k] && !payload[k].to_s.strip.empty? }
          response.status = 400
          next({ error: "Missing required fields" }.to_json)
        end

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ SQLite
        Payment.create(
          order_guid: payload["order_guid"],
          receipt_url: payload["receipt_url"],
          chat_id: payload["chat_id"],
          paid_at: Time.now
        )

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
        send_thank_you_message(
          chat_id: payload["chat_id"],
          order_guid: payload["order_guid"],
          receipt_url: payload["receipt_url"]
        )

        { status: "ok", message: "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞" }.to_json

      rescue => e
        response.status = 500
        { error: "Callback failed: #{e.message}" }.to_json
      end
    end

    r.on "whatsapp" do
      
      r.get do
        if r.params["hub.mode"] == "subscribe" || r.params["hub.verify_token"] == ENV["WHATSAPP_VERIFY_TOKEN"]
          r.params["hub.challenge"]
        else
          response.status = 403
          "Forbidden"
        end
      end

     r.post do
  begin
    request_body = request.body.read
    payload = JSON.parse(request_body)

    # –õ–æ–≥–∏—Ä—É–µ–º –≤–µ—Å—å –≤—Ö–æ–¥—è—â–∏–π payload –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    puts "üì• WhatsApp payload:"
    puts JSON.pretty_generate(payload)

    messages = payload.dig("entry", 0, "changes", 0, "value", "messages")

    if messages.nil? || messages.empty?
      response.status = 400
      puts "‚ö†Ô∏è –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ payload"
      next "‚ùå –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
    end

    from = messages.dig(0, "from")
    text = messages.dig(0, "text", "body")

    if from && text
      puts "üë§ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç #{from}: #{text.inspect}"
      result = WhatsappHandler.process_message(text, from)
      result ? "‚úÖ OK" : "‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å"
    else
      response.status = 400
      puts "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ from –∏–ª–∏ text"
      "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"
    end

  rescue JSON::ParserError => e
    response.status = 400
    puts "‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: #{e.message}"
    "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON"

  rescue => e
    response.status = 500
    puts "‚ùå –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: #{e.message}"
    "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"
  end
end

    end
  end

  # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
  def send_thank_you_message(chat_id:, order_guid:, receipt_url:)
    token = ENV["TELEGRAM_BOT_TOKEN"]
    uri = URI("https://api.telegram.org/bot#{token}/sendMessage")

    message = <<~TEXT
      ‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–ª–∞—Ç—É –∑–∞–∫–∞–∑–∞ ‚Ññ#{order_guid}!
      üí≥ –í–∞—à —á–µ–∫: #{receipt_url}
    TEXT

    res = Net::HTTP.post_form(uri, {
      "chat_id" => chat_id,
      "text"    => message.strip
    })

    puts "üì§ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: #{res.body}"
  end
end
